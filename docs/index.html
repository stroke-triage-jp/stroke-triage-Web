<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Stroke Triage (Web)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#f5f6f7;--card:#fff;--border:rgba(0,0,0,0.10);--shadow:0 1px 2px rgba(0,0,0,0.06);
      --text:#111;--muted:#6b7280;--accent:#0a84ff;--ok:#16a34a;--warn:#f59e0b;--bad:#dc2626;
    }
    body{font-family:-apple-system,system-ui,sans-serif;margin:0;color:var(--text);background:var(--bg);}
    .container{max-width:960px;margin:0 auto;padding:14px;}
    h1{font-size:22px;margin:8px 0 12px;text-align:center;}
    /* ステップヘッダー */
    .steps{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:6px 0 12px;}
    .step{padding:8px 12px;border-radius:999px;background:#fff;border:1px solid var(--border);cursor:pointer}
    .step.on{background:rgba(10,132,255,0.12);color:var(--accent);border-color:rgba(10,132,255,0.4)}
    /* セクション/カード */
    .section{margin-bottom:14px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow);}
    .card h3{margin:0 0 10px;font-size:16px;display:flex;align-items:center;gap:8px;}
    .row{display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:center;margin:10px 0;}
    label{font-size:13px;color:#333;}
    /* 入力 */
    input,select,textarea{
      width:100%;padding:14px 14px;border:1px solid var(--border);border-radius:10px;background:#fff;box-sizing:border-box;font-size:16px;
    }
    textarea{font-family:-apple-system,system-ui,sans-serif}
    /* ピル/セグメント */
    .pill{display:inline-block;padding:12px 14px;border-radius:14px;border:1px solid var(--border);cursor:pointer;user-select:none;font-size:15px;}
    .pill.on{background:rgba(10,132,255,0.12);color:var(--accent);border-color:rgba(10,132,255,0.4)}
    .pill-group{display:flex;flex-wrap:wrap;gap:8px;}
    .seg{display:inline-grid;grid-auto-flow:column;gap:8px}
    .seg button{padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fff;cursor:pointer;font-size:15px;}
    .seg button.on{background:rgba(10,132,255,0.12);color:var(--accent);border-color:rgba(10,132,255,0.4)}
    /* バッジ */
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted);}
    .ok{color:var(--ok);border-color:rgba(22,163,74,0.4);background:rgba(22,163,74,0.08)}
    .warn{color:var(--warn);border-color:rgba(245,158,11,0.4);background:rgba(245,158,11,0.08)}
    .bad{color:var(--bad);border-color:rgba(220,38,38,0.4);background:rgba(220,38,38,0.08)}
    /* 2列グリッド/ツールバー/ボタン */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .toolbar{position:sticky;bottom:0;background:rgba(245,246,247,0.92);backdrop-filter:saturate(180%) blur(10px);
      padding:10px 0;border-top:1px solid rgba(0,0,0,0.06)}
    .btn{padding:14px 16px;border:0;border-radius:12px;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;font-size:16px;}
    .btn.secondary{background:#fff;color:#111;border:1px solid var(--border)}
    .hint{font-size:12px;color:var(--muted)}
    @media(max-width:640px){.row{grid-template-columns:1fr}.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>Stroke Triage</h1>

    <!-- ステップヘッダー（アプリのタブ風） -->
    <div class="steps" id="steps"></div>

    <!-- Overview -->
    <div class="section" data-step="overview">
      <div class="card">
        <h3>基本情報 <span id="basicState" class="badge">未入力</span></h3>
        <div class="row"><label>ID</label><input id="patientID" placeholder="例: 123456"></div>
        <div class="row"><label>年齢</label><input id="age" inputmode="numeric" placeholder="例: 56"></div>
        <div class="row"><label>性別</label>
          <select id="sex"><option>男</option><option>女</option></select>
        </div>
        <div class="row"><label>最終健在</label><input id="lkw" type="datetime-local"></div>
        <div class="row"><label>発見・発症時刻</label><input id="disc" type="datetime-local"></div>
        <div class="row"><label>経過</label><input id="elapsed" readonly placeholder="自動計算"></div>

        <div class="card" style="margin-top:10px">
          <h3>バイタル</h3>
          <div class="grid2">
            <div class="row"><label>JCS</label><input id="jcs"></div>
            <div class="row"><label>GCS</label><input id="gcs" placeholder="E V M"></div>
            <div class="row"><label>BP</label><input id="bp" placeholder="120/80"></div>
            <div class="row"><label>SpO₂</label><input id="spo2" inputmode="numeric" placeholder="％"></div>
            <div class="row"><label>HR</label><input id="hr" inputmode="numeric" placeholder="/分"></div>
            <div class="row"><label>BS/BT</label><input id="bsbt" placeholder="BS mg/dl / BT ℃"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 6項目 -->
    <div class="section" data-step="six">
      <div class="card">
        <h3>6項目 <span id="sixState" class="badge">未入力</span></h3>
        <div class="pill-group" id="sixItems"></div>
        <div class="hint">各項目「なし / あり」を選択</div>
      </div>
    </div>

    <!-- CPSS / ELVO -->
    <div class="section" data-step="cpss">
      <div class="card">
        <h3>CPSS <span id="cpssState" class="badge">未入力</span></h3>
        <div class="row"><label>顔面</label><div class="seg" id="cpssFace"></div></div>
        <div class="row"><label>上肢</label><div class="seg" id="cpssArm"></div></div>
        <div class="row"><label>言語</label><div class="seg" id="cpssSpeech"></div></div>
        <div class="row"><label>判定</label><input id="cpssJudge" readonly></div>
      </div>
      <div class="card" style="margin-top:10px">
        <h3>ELVO</h3>
        <div class="row"><label>眼球位置</label><div class="seg" id="elvoGaze"></div></div>
        <div class="row"><label>物品呼称</label><div class="seg" id="elvoNaming"></div></div>
        <div class="row"><label>指の数</label><div class="seg" id="elvoFingers"></div></div>
      </div>
    </div>

    <!-- KPSS -->
    <div class="section" data-step="kpss">
      <div class="card">
        <h3>KPSS <span id="kpssState" class="badge">未入力</span></h3>
        <div class="row"><label>意識水準</label><div class="seg" id="kpssArousal"></div></div>
        <div class="row"><label>質問</label><div class="seg" id="kpssQ"></div></div>
        <div class="row"><label>上肢 右</label><div class="seg" id="kpssUR"></div></div>
        <div class="row"><label>上肢 左</label><div class="seg" id="kpssUL"></div></div>
        <div class="row"><label>下肢 右</label><div class="seg" id="kpssLR"></div></div>
        <div class="row"><label>下肢 左</label><div class="seg" id="kpssLL"></div></div>
        <div class="row"><label>言語</label><div class="seg" id="kpssLang"></div></div>
        <div class="row"><label>合計</label><input id="kpssTotal" readonly></div>
      </div>
    </div>

    <!-- 共有 -->
    <div class="section" data-step="summary">
      <div class="card">
        <h3>共有</h3>
        <div class="grid2" style="margin-bottom:8px;">
          <button class="btn" onclick="generate()">サマリ生成</button>
          <button class="btn secondary" onclick="copyOut()">コピー</button>
        </div>
        <div class="row" style="grid-template-columns:1fr;">
          <textarea id="out" rows="14" placeholder="ここにサマリが出ます"></textarea>
        </div>
        <div style="margin-top:8px;">
          <button class="btn secondary" onclick="shareOut()">共有</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ボトムツールバー（戻る/次へ） -->
  <div class="toolbar">
    <div class="container">
      <div class="grid2">
        <button class="btn secondary" onclick="prevStep()">戻る</button>
        <button class="btn" onclick="nextStep()">次へ</button>
      </div>
    </div>
  </div>

<script>
const steps = [
  {id:'overview', title:'基本情報'},
  {id:'six',      title:'６項目'},
  {id:'cpss',     title:'CPSS/ELVO'},
  {id:'kpss',     title:'KPSS'},
  {id:'summary',  title:'共有'}
];
let current = 0;
function renderSteps(){
  const c = document.getElementById('steps'); c.innerHTML='';
  steps.forEach((s,idx)=>{
    const b=document.createElement('button');
    b.className='step'+(idx===current?' on':'');
    b.textContent=s.title;
    b.onclick=()=>{current=idx;updateVisible();};
    c.appendChild(b);
  });
}
function updateVisible(){
  document.querySelectorAll('[data-step]').forEach(sec=>{
    sec.style.display = (sec.getAttribute('data-step')===steps[current].id)?'block':'none';
  });
  renderSteps();
}
function nextStep(){ if(current<steps.length-1){ current++; updateVisible(); } }
function prevStep(){ if(current>0){ current--; updateVisible(); } }

const $ = s => document.querySelector(s);
const v = id => document.getElementById(id).value;
const set = (id, text) => document.getElementById(id).value = text;

/* 2択/3択のセグメントUI */
function seg2(id, on){
  const el=document.getElementById(id); el.innerHTML='';
  ['正常','異常'].forEach((lab,idx)=>{
    const b=document.createElement('button'); b.textContent=lab; b.onclick=()=>{ [...el.children].forEach(c=>c.classList.remove('on')); b.classList.add('on'); on(idx); updateStates(); };
    el.appendChild(b);
  });
}
function seg3(id, on, labels=['0','1','2']){
  const el=document.getElementById(id); el.innerHTML='';
  labels.forEach((lab,idx)=>{
    const b=document.createElement('button'); b.textContent=lab; b.onclick=()=>{ [...el.children].forEach(c=>c.classList.remove('on')); b.classList.add('on'); on(idx); updateStates(); };
    el.appendChild(b);
  });
}

/* 状態 */
let state = {
  lkw:null, disc:null,
  six:[null,null,null,null,null,null],
  cpss:{face:null,arm:null,speech:null},
  elvo:{gaze:null,naming:null,fingers:null},
  kpss:{arousal:null,q:null,ur:null,ul:null,lr:null,ll:null,lang:null}
};

/* ロジック */
function fmtElapsed(lkw,disc){
  if(!lkw||!disc) return null;
  const min=Math.round((disc-lkw)/60000);
  const a=Math.abs(min), h=Math.floor(a/60), m=a%60;
  return h>0?`${h}時間${m}分`:`${m}分`;
}
function cpssJudge(f,a,s){
  if(f==null&&a==null&&s==null) return '未入力';
  if(f==null||a==null||s==null) return '一部未入力';
  return (f===1||a===1||s===1)?'陽性':'陰性';
}
function kpssScore(k){
  const vals=[k.arousal,k.q,k.ur,k.ul,k.lr,k.ll,k.lang];
  if(vals.some(v=>v==null)) return null;
  return vals.reduce((x,y)=>x+y,0);
}

/* ステータス更新 */
function updateStates(){
  const lkwStr=v('lkw'), discStr=v('disc');
  state.lkw = lkwStr? new Date(lkwStr): null;
  state.disc = discStr? new Date(discStr): null;
  const elapsed=fmtElapsed(state.lkw,state.disc);
  set('elapsed', elapsed??'—');

  const basicOK = (v('age') && (state.lkw||state.disc));
  const basicPart = (v('age')||state.lkw||state.disc);
  const bEl=$('#basicState'); bEl.className='badge '+(basicOK?'ok':(basicPart?'warn':'bad')); bEl.textContent=basicOK?'入力済み':(basicPart?'一部未入力':'未入力');

  const sixFilled=state.six.filter(x=>x!=null).length;
  const sEl=$('#sixState'); sEl.className='badge '+(sixFilled===0?'bad':(sixFilled===6?'ok':'warn')); sEl.textContent=sixFilled===0?'未入力':(sixFilled===6?'入力済み':'一部未入力');

  const cj=cpssJudge(state.cpss.face,state.cpss.arm,state.cpss.speech);
  set('cpssJudge', cj);
  const cEl=$('#cpssState'); cEl.className='badge '+(cj==='陽性'||cj==='陰性'?'ok':(cj==='一部未入力'?'warn':'bad')); cEl.textContent=cj;

  const ks=kpssScore(state.kpss);
  set('kpssTotal', ks==null?'—':`${ks}`);
  const kFilled=Object.values(state.kpss).filter(x=>x!=null).length;
  const kEl=$('#kpssState'); kEl.className='badge '+(kFilled===0?'bad':(kFilled===7?'ok':'warn')); kEl.textContent=kFilled===0?'未入力':(kFilled===7?'入力済み':'一部未入力');
}

/* サマリ生成（アプリのsummaryTextに寄せる） */
function generate(){
  updateStates();
  const timeStr=d=>d? new Date(d).toLocaleString(): '不明';
  const sixText=(i,l)=>{const x=state.six[i]; return `${l}: ${x==null?'—':(x===0?'なし':'あり')}`};

  const cpssPart=[
    `顔面: ${state.cpss.face==null?'—':(state.cpss.face===0?'正常':'異常')}`,
    `上肢: ${state.cpss.arm==null?'—':(state.cpss.arm===0?'正常':'異常')}`,
    `言語: ${state.cpss.speech==null?'—':(state.cpss.speech===0?'正常':'異常')}`
  ].join(' / ');

  const elvoPart=[
    `眼球位置: ${state.elvo.gaze==null?'—':(state.elvo.gaze===0?'正中':(state.elvo.gaze===1?'共同偏視':'評価困難'))}`,
    `物品呼称: ${state.elvo.naming==null?'—':(state.elvo.naming===0?'できる':(state.elvo.naming===1?'できない':'評価困難'))}`,
    `指の数: ${state.elvo.fingers==null?'—':(state.elvo.fingers===0?'できる':(state.elvo.fingers===1?'できない':'評価困難'))}`
  ].join('\n・');

  const ks=kpssScore(state.kpss);
  const kpssItems=[
    `意識水準: ${state.kpss.arousal??'—'}`,
    `意識障害: ${state.kpss.q??'—'}`,
    `上肢R: ${state.kpss.ur??'—'}`,
    `上肢L: ${state.kpss.ul??'—'}`,
    `下肢R: ${state.kpss.lr??'—'}`,
    `下肢L: ${state.kpss.ll??'—'}`,
    `言語: ${state.kpss.lang??'—'}`
  ].join(', ');

  const summary = [
    '脳卒中対応記録',
    '',
    `ID: ${v('patientID')||'—'}`,
    `年齢: ${v('age')||'—'}　性別: ${v('sex')}`,
    `最終健在: ${timeStr(state.lkw)}`,
    `発見・発症時刻: ${timeStr(state.disc)}`,
    `経過: ${document.getElementById('elapsed').value || '—'}`,
    '',
    'バイタル:',
    `・JCS: ${v('jcs')||'—'} / GCS: ${v('gcs')||'—'}`,
    `・BP: ${v('bp')||'—'}  SpO₂: ${v('spo2')||'—'}  HR: ${v('hr')||'—'}`,
    `・BS/BT: ${v('bsbt')||'—'}`,
    '',
    '6項目:',
    `・${sixText(0,'脈不整')}`,
    `・${sixText(1,'共同偏視')}`,
    `・${sixText(2,'半側空間無視')}`,
    `・${sixText(3,'半盲')}`,
    `・${sixText(4,'失語')}`,
    `・${sixText(5,'片麻痺')}`,
    '',
    `CPSS: ${document.getElementById('cpssJudge').value}`,
    `・${cpssPart}`,
    '',
    'ELVO:',
    `・${elvoPart}`,
    '',
    `KPSS: 合計 ${ks==null?'—':ks}`,
    `・${kpssItems}`
  ].join('\n');

  set('out', summary);
}

/* コピー/共有 */
function copyOut(){
  const t=document.getElementById('out');
  t.select(); document.execCommand('copy'); t.setSelectionRange(0,0);
  alert('コピーしました');
}
async function shareOut(){
  const text=document.getElementById('out').value||'';
  if(navigator.share){ try{ await navigator.share({text}); }catch(e){} }
  else{ copyOut(); }
}

/* 初期化：UI構築とイベント */
function init(){
  // ステップ
  renderSteps(); updateVisible();

  // 6項目（なし/あり）
  const sixLabels=['脈不整','共同偏視','半側空間無視','半盲','失語','片麻痺'];
  const cont=document.getElementById('sixItems');
  sixLabels.forEach((lab,idx)=>{
    const a=document.createElement('span'); a.className='pill'; a.textContent=lab+' なし';
    const b=document.createElement('span'); b.className='pill'; b.textContent=lab+' あり';
    a.onclick=()=>{ state.six[idx]=0; a.classList.add('on'); b.classList.remove('on'); updateStates(); };
    b.onclick=()=>{ state.six[idx]=1; b.classList.add('on'); a.classList.remove('on'); updateStates(); };
    cont.appendChild(a); cont.appendChild(b);
  });

  // CPSS（正常/異常）
  seg2('cpssFace',   i=>state.cpss.face=i);
  seg2('cpssArm',    i=>state.cpss.arm=i);
  seg2('cpssSpeech', i=>state.cpss.speech=i);

  // ELVO（日本語ラベル）
  seg3('elvoGaze',    i=>state.elvo.gaze=i,   ['正中','共同偏視','評価困難']);
  seg3('elvoNaming',  i=>state.elvo.naming=i, ['できる','できない','評価困難']);
  seg3('elvoFingers', i=>state.elvo.fingers=i,['できる','できない','評価困難']);

  // KPSS（0/1/2）
  seg3('kpssArousal', i=>state.kpss.arousal=i, ['0','1','2']);
  seg2('kpssQ',       i=>state.kpss.q=i);
  seg3('kpssUR',      i=>state.kpss.ur=i, ['0','1','2']);
  seg3('kpssUL',      i=>state.kpss.ul=i, ['0','1','2']);
  seg3('kpssLR',      i=>state.kpss.lr=i, ['0','1','2']);
  seg3('kpssLL',      i=>state.kpss.ll=i, ['0','1','2']);
  seg3('kpssLang',    i=>state.kpss.lang=i, ['0','1','2']);

  // 入力変化で状態更新
  ['age','lkw','disc','patientID','sex','jcs','gcs','bp','spo2','hr','bsbt'].forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener('input', updateStates);
    el.addEventListener('change', updateStates);
  });

  updateStates();
}
init();
</script>
</body>
</html>
